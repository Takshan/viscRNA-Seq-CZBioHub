#!/usr/bin/env python
'''
Append virus sequence and annotations to host transcriptome
'''
import os
import subprocess as sp
import argparse
from Bio import SeqIO


def main(
        virus_gb,
        genome_fasta,
        transcriptome_gtf,
        fdn_output):

    virus_seq = SeqIO.read(virus_gb, 'gb')

    fdn_output = fdn_output.rstrip('/')+'/'
    os.makedirs(fdn_output)

    print('Save virus FASTA')
    virus_fasta = virus_gb[:-2]+'fasta'
    # Sequence name must be chromosome number
    virus_seq.id = '1'
    virus_seq.name = '1'
    SeqIO.write(virus_seq, virus_fasta, 'fasta')

    print('Save virus GTF')
    virus_gtf = virus_gb[:-2]+'gtf'
    virus_annotations = []
    for fea in virus_seq.features:
        if fea.type != 'CDS':
            continue

        gene_id = fea.qualifiers['db_xref'][0].split(':')[1]
        strand = '+' if fea.strand > 0 else '-'

        # Gene
        fields = [
                '1',
                'genbank',
                'gene',
                str(fea.location.start),
                str(fea.location.end),
                '1',
                strand,
                '0',
                'gene_id "{:}"'.format(gene_id),
                ]
        virus_annotations.append('\t'.join(fields))

        # Transcript
        fields = [
                '1',
                'genbank',
                'transcript',
                str(fea.location.start),
                str(fea.location.end),
                '1',
                strand,
                '0',
                'gene_id "{:}"; transcript_id "{:}"'.format(
                    gene_id,
                    'tr'+gene_id,
                    ),
                ]
        virus_annotations.append('\t'.join(fields))

        # Exons
        for loc in fea.location.parts:
            fields = [
                    '1',
                    'genbank',
                    'exon',
                    str(loc.start),
                    str(loc.end),
                    '1',
                    strand,
                    '0',
                    'gene_id "{:}"; transcript_id "{:}"'.format(
                        gene_id,
                        'tr'+gene_id,
                        ),
                    ]
            virus_annotations.append('\t'.join(fields))

    with open(virus_gtf, 'wt') as f:
        for line in virus_annotations:
            f.write(line+'\n')

    pardir = os.path.dirname(fdn_output.rstrip('/'))
    basename = os.path.basename(fdn_output.rstrip('/'))
    print('Compute combined hash for {:} and mCMV'.format(basename))
    print('NOTE: this requires some computing power (8 cores recommended, 32GB RAM)')
    os.chdir(pardir)
    sp.run(' '.join([
        'cellranger',
        'mkref',
        '--genome={:}'.format(basename),
        '--fasta={:}'.format(genome_fasta),
        '--genes={:}'.format(transcriptome_gtf),
        '--genome={:}'.format('mCMV'),
        '--fasta={:}'.format(virus_fasta),
        '--genes={:}'.format(virus_gtf),
        ]),
        shell=True,
        check=True,
        )


if __name__ == '__main__':

    pa = argparse.ArgumentParser(description='''Append virus to transcriptome''')
    pa.add_argument(
            '--virus-gb', required=True,
            help='Virus reference GenBank file',
            )
    pa.add_argument(
            '--genome-fasta', required=True,
            help='The host genome fasta file',
            )
    pa.add_argument(
            '--transcriptome-gtf', required=True,
            help='The host transcriptome annotation GTF file',
            )
    pa.add_argument(
            '--output', required=True,
            help='The output folder name',
            )

    args = pa.parse_args()

    print('Regenerating transcriptome hashes')
    main(args.virus_gb,
         args.genome_fasta,
         args.transcriptome_gtf,
         args.output,
         )
